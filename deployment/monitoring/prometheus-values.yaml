# Custom values for kube-prometheus-stack

# Prometheus configuration
prometheus:
  prometheusSpec:
    # Storage configuration
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: fast-ssd
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi
    
    # Retention settings
    retention: 30d
    retentionSize: "50Gi"
    
    # Resource limits
    resources:
      requests:
        memory: 4Gi
        cpu: 2
      limits:
        memory: 8Gi
        cpu: 4
    
    # Scrape configuration
    scrapeInterval: 30s
    evaluationInterval: 30s
    
    # Additional scrape configs
    additionalScrapeConfigs:
      - job_name: 'credit-scoring-api'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            action: keep
            regex: credit-scoring-api
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: metrics
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_version]
            target_label: version
      
      - job_name: 'credit-scoring-training'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: credit-scoring-training
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
      
      - job_name: 'node-exporter'
        static_configs:
          - targets: ['node-exporter:9100']
      
      - job_name: 'kube-state-metrics'
        static_configs:
          - targets: ['kube-state-metrics:8080']
      
      - job_name: 'cadvisor'
        static_configs:
          - targets: ['cadvisor:8080']
    
    # Rule files
    ruleSelector:
      matchLabels:
        role: prometheus-rulefiles
        prometheus: credit-scoring
    
    # Alerting configuration
    alerting:
      alertmanagers:
        - namespace: monitoring
          name: alertmanager
          port: web

# Alertmanager configuration
alertmanager:
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: fast-ssd
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    
    # Alertmanager config
    config:
      global:
        slack_api_url: '{{ .Values.slack_webhook_url }}'
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: '{{ .Values.alert_email }}'
        smtp_auth_username: '{{ .Values.smtp_username }}'
        smtp_auth_password: '{{ .Values.smtp_password }}'
      
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'slack-notifications'
        routes:
          - match:
              severity: critical
            receiver: 'pagerduty'
            continue: true
          - match:
              namespace: credit-scoring-production
            receiver: 'slack-production'
          - match:
              namespace: credit-scoring-staging
            receiver: 'slack-staging'
      
      receivers:
        - name: 'slack-notifications'
          slack_configs:
            - channel: '#alerts-general'
              title: '{{ template "slack.default.title" . }}'
              text: '{{ template "slack.default.text" . }}'
              icon_emoji: 'üö®'
              send_resolved: true
        
        - name: 'slack-production'
          slack_configs:
            - channel: '#alerts-production'
              title: '{{ template "slack.default.title" . }}'
              text: '{{ template "slack.production.text" . }}'
              icon_emoji: 'üî•'
              send_resolved: true
        
        - name: 'slack-staging'
          slack_configs:
            - channel: '#alerts-staging'
              title: '{{ template "slack.default.title" . }}'
              text: '{{ template "slack.staging.text" . }}'
              icon_emoji: '‚ö†Ô∏è'
              send_resolved: true
        
        - name: 'pagerduty'
          pagerduty_configs:
            - service_key: '{{ .Values.pagerduty_service_key }}'
              description: '{{ .CommonAnnotations.summary }}'
              severity: 'critical'
        
        - name: 'email'
          email_configs:
            - to: '{{ .Values.alert_email }}'
              from: '{{ .Values.smtp_from }}'
              smarthost: '{{ .Values.smtp_smarthost }}'
              auth_username: '{{ .Values.smtp_username }}'
              auth_password: '{{ .Values.smtp_password }}'
              send_resolved: true

# Grafana configuration
grafana:
  adminPassword: '{{ .Values.grafana_admin_password }}'
  
  persistence:
    enabled: true
    storageClassName: fast-ssd
    size: 10Gi
  
  # Dashboards
  dashboards:
    default:
      credit-scoring-overview:
        gnetId: 0
        revision: 1
        datasource: Prometheus
      model-metrics:
        gnetId: 0
        revision: 1
        datasource: Prometheus
      infrastructure:
        gnetId: 0
        revision: 1
        datasource: Prometheus
  
  # Dashboard providers
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'default'
          orgId: 1
          folder: ''
          type: file
          disableDeletion: false
          editable: true
          options:
            path: /var/lib/grafana/dashboards/default
  
  # Dashboards configmaps
  dashboardsConfigMaps:
    default: grafana-dashboards

# Additional configuration
kube-state-metrics:
  enabled: true

node-exporter:
  enabled: true

prometheus-node-exporter:
  enabled: true

# Custom templates for alerts
extraSecret:
  alert-templates:
    slack.default.title: |-
      [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} ({{ .CommonLabels.cluster }})
    slack.default.text: |-
      {{ range .Alerts }}
      *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
      *Description:* {{ .Annotations.description }}
      *Details:*
        {{ range .Labels.SortedPairs }} ‚Ä¢ *{{ .Name }}:* `{{ .Value }}`
        {{ end }}
      {{ end }}
    slack.production.text: |-
      üî• *PRODUCTION ALERT*
      {{ range .Alerts }}
      *Alert:* {{ .Annotations.title }}
      *Impact:* {{ .Annotations.impact }}
      *Action Required:* {{ .Annotations.action }}
      *Details:* {{ .Annotations.details }}
      {{ end }}
    slack.staging.text: |-
      ‚ö†Ô∏è *STAGING ALERT*
      {{ range .Alerts }}
      *Alert:* {{ .Annotations.title }}
      *Environment:* Staging
      *Details:* {{ .Annotations.details }}
      {{ end }}